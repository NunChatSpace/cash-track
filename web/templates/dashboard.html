{{define "content"}}
<div class="dashboard-container" data-cutoff-day="{{if .CurrentUser}}{{.CurrentUser.CutoffDay}}{{else}}29{{end}}">
    <h1 data-i18n="dashboard.title">Dashboard</h1>

    <div class="date-range-picker">
        <button class="btn btn-filter active" data-range="month" data-i18n="dashboard.range.month">เดือนนี้</button>
        <button class="btn btn-filter" data-range="last-month" data-i18n="dashboard.range.last_month">เดือนที่แล้ว</button>
        <button class="btn btn-filter" data-range="year" data-i18n="dashboard.range.year">ปีนี้</button>
        <div class="custom-range">
            <button type="button" class="user-cutoff" id="cutoffBtn">ตัดรอบทุกๆวันที่ {{if .CurrentUser}}{{.CurrentUser.CutoffDay}}{{else}}1{{end}}</button>
            <input type="date" id="fromDate">
            <span data-i18n="dashboard.range.to">ถึง</span>
            <input type="date" id="toDate">
            <button class="btn btn-small" id="applyRange" data-i18n="dashboard.range.apply">ใช้</button>
        </div>
    </div>

    <div class="pending-banner hidden" id="pendingBanner">
        <span class="typing-indicator"><span></span><span></span><span></span></span>
        <span data-i18n="dashboard.processing">Processing slip...</span>
    </div>

    <div class="summary-cards">
        <div class="summary-card expense">
            <div class="card-label" data-i18n="dashboard.summary.expense">รายจ่าย</div>
            <div class="card-value" id="totalExpense">0.00</div>
            <div class="card-unit" data-i18n="labels.thb">บาท</div>
        </div>
        <div class="summary-card income">
            <div class="card-label" data-i18n="dashboard.summary.income">รายรับ</div>
            <div class="card-value" id="totalIncome">0.00</div>
            <div class="card-unit" data-i18n="labels.thb">บาท</div>
        </div>
        <div class="summary-card net">
            <div class="card-label" data-i18n="dashboard.summary.net">คงเหลือ</div>
            <div class="card-value" id="netAmount">0.00</div>
            <div class="card-unit" data-i18n="labels.thb">บาท</div>
        </div>
    </div>

    <div class="charts-row">
        <div class="chart-container">
            <h3 data-i18n="dashboard.charts.by_category">รายจ่ายตามหมวด</h3>
            <canvas id="categoryChart"></canvas>
            <div class="chart-legend" id="categoryLegend"></div>
        </div>
        <div class="chart-container">
            <h3 data-i18n="dashboard.charts.by_channel">รายจ่ายตามช่องทาง</h3>
            <canvas id="channelChart"></canvas>
        </div>
    </div>

    <div class="grouped-transactions">
        <div class="grouped-block">
            <h3 data-i18n="dashboard.groups.by_category">รายการตามหมวด</h3>
            <div id="categoryGroups" class="group-list"></div>
        </div>
        <div class="grouped-block">
            <h3 data-i18n="dashboard.groups.by_channel">รายการตามช่องทาง</h3>
            <div id="channelGroups" class="group-list"></div>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
let categoryChart = null;
let channelChart = null;

const categoryColors = {
    'food': '#FF6384',
    'shopping': '#36A2EB',
    'transport': '#FFCE56',
    'bill': '#4BC0C0',
    'rent': '#9966FF',
    'debt': '#FF9F40',
    'other': '#C9CBCF',
    'uncategorized': '#999999'
};

function getLocale() {
    return (window.CashTrackI18n && CashTrackI18n.getLocale()) || 'th-TH';
}

function getCategoryLabel(key) {
    const map = (window.CashTrackI18n && CashTrackI18n.categories && CashTrackI18n.categories()) || {};
    return map[key] || key;
}

const container = document.querySelector('.dashboard-container');
const CUTOFF_DAY = parseInt((container && container.dataset.cutoffDay) || '29', 10); // Spending period starts on cutoff day

function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function clampDay(year, month, day) {
    const last = new Date(year, month + 1, 0).getDate();
    return Math.min(Math.max(day, 1), last);
}

function getDateRange(range) {
    const now = new Date();
    let from, to;

    switch (range) {
        case 'month':
            // Current period: 29th of last month to 28th of this month
            if (now.getDate() >= CUTOFF_DAY) {
                // We're in the new period (29th onwards)
                from = new Date(now.getFullYear(), now.getMonth(), clampDay(now.getFullYear(), now.getMonth(), CUTOFF_DAY));
                to = new Date(now.getFullYear(), now.getMonth() + 1, clampDay(now.getFullYear(), now.getMonth() + 1, CUTOFF_DAY - 1));
            } else {
                // We're still in the previous period (before 29th)
                from = new Date(now.getFullYear(), now.getMonth() - 1, clampDay(now.getFullYear(), now.getMonth() - 1, CUTOFF_DAY));
                to = new Date(now.getFullYear(), now.getMonth(), clampDay(now.getFullYear(), now.getMonth(), CUTOFF_DAY - 1));
            }
            break;
        case 'last-month':
            // Previous period
            if (now.getDate() >= CUTOFF_DAY) {
                from = new Date(now.getFullYear(), now.getMonth() - 1, clampDay(now.getFullYear(), now.getMonth() - 1, CUTOFF_DAY));
                to = new Date(now.getFullYear(), now.getMonth(), clampDay(now.getFullYear(), now.getMonth(), CUTOFF_DAY - 1));
            } else {
                from = new Date(now.getFullYear(), now.getMonth() - 2, clampDay(now.getFullYear(), now.getMonth() - 2, CUTOFF_DAY));
                to = new Date(now.getFullYear(), now.getMonth() - 1, clampDay(now.getFullYear(), now.getMonth() - 1, CUTOFF_DAY - 1));
            }
            break;
        case 'year':
            from = new Date(now.getFullYear(), 0, 1);
            to = new Date(now.getFullYear(), 11, 31);
            break;
        default:
            if (now.getDate() >= CUTOFF_DAY) {
                from = new Date(now.getFullYear(), now.getMonth(), CUTOFF_DAY);
                to = new Date(now.getFullYear(), now.getMonth() + 1, CUTOFF_DAY - 1);
            } else {
                from = new Date(now.getFullYear(), now.getMonth() - 1, CUTOFF_DAY);
                to = new Date(now.getFullYear(), now.getMonth(), CUTOFF_DAY - 1);
            }
    }

    return {
        from: formatDate(from),
        to: formatDate(to)
    };
}

async function fetchDashboard(from, to) {
    try {
        const response = await fetch(`/api/dashboard/summary?from=${from}&to=${to}`);
        if (!response.ok) throw new Error('Failed to fetch');
        return await response.json();
    } catch (e) {
        console.error('Fetch error:', e);
        return null;
    }
}

async function fetchTransactions(from, to, params) {
    const search = new URLSearchParams({
        from,
        to,
        limit: '6',
        ...params
    });
    try {
        const response = await fetch(`/api/dashboard/transactions?${search.toString()}`);
        if (!response.ok) throw new Error('Failed to fetch');
        return await response.json();
    } catch (e) {
        console.error('Fetch transactions error:', e);
        return [];
    }
}

function updateSummaryCards(data) {
    document.getElementById('totalExpense').textContent = data.total_expense.toLocaleString(getLocale(), {minimumFractionDigits: 2});
    document.getElementById('totalIncome').textContent = data.total_income.toLocaleString(getLocale(), {minimumFractionDigits: 2});

    const net = data.total_income - data.total_expense;
    const netEl = document.getElementById('netAmount');
    netEl.textContent = net.toLocaleString(getLocale(), {minimumFractionDigits: 2});
    netEl.parentElement.classList.toggle('negative', net < 0);
}

function renderCategoryChart(data) {
    const ctx = document.getElementById('categoryChart').getContext('2d');

    if (categoryChart) {
        categoryChart.destroy();
    }

    const labels = data.by_category.map(c => getCategoryLabel(c.category));
    const values = data.by_category.map(c => c.amount);
    const colors = data.by_category.map(c => categoryColors[c.category] || '#999');

    categoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw.toLocaleString(getLocale());
                            const percent = data.by_category[context.dataIndex].percent_of_expense.toFixed(1);
                            const unit = (window.CashTrackI18n && CashTrackI18n.t) ? CashTrackI18n.t('labels.thb') : 'บาท';
                            return `${context.label}: ${value} ${unit} (${percent}%)`;
                        }
                    }
                }
            }
        }
    });

    // Custom legend
    const legendEl = document.getElementById('categoryLegend');
    legendEl.innerHTML = data.by_category.map((c, i) => `
        <div class="legend-item">
            <span class="legend-color" style="background: ${colors[i]}"></span>
            <span class="legend-label">${labels[i]}</span>
            <span class="legend-value">${c.amount.toLocaleString(getLocale())} (${c.percent_of_expense.toFixed(1)}%)</span>
        </div>
    `).join('');
}

function renderChannelChart(data) {
    const ctx = document.getElementById('channelChart').getContext('2d');

    if (channelChart) {
        channelChart.destroy();
    }

    const labels = data.by_channel.map(c => c.channel.toUpperCase());
    const values = data.by_channel.map(c => c.amount);

    channelChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: (window.CashTrackI18n && CashTrackI18n.t) ? CashTrackI18n.t('dashboard.amount_thb') : 'จำนวนเงิน (บาท)',
                data: values,
                backgroundColor: '#36A2EB',
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString(getLocale());
                        }
                    }
                }
            }
        }
    });
}

async function loadDashboard(from, to) {
    const data = await fetchDashboard(from, to);
    if (!data) return;

    updateSummaryCards(data);
    renderCategoryChart(data);
    renderChannelChart(data);
    renderGroupedTransactionsAsync(data.by_category || [], data.by_channel || [], from, to);
}

function getChannelLabel(key) {
    if (!window.CashTrackI18n) return key;
    if (key === 'cash') return CashTrackI18n.t('labels.channel_cash');
    if (key === 'scb') return CashTrackI18n.t('labels.channel_scb');
    if (key === 'kbank') return CashTrackI18n.t('labels.channel_kbank');
    if (key === 'tmw') return CashTrackI18n.t('labels.channel_tmw');
    if (key === 'bbl') return CashTrackI18n.t('labels.channel_bbl');
    if (key === 'ktb') return CashTrackI18n.t('labels.channel_ktb');
    if (key === 'other') return CashTrackI18n.t('labels.channel_other');
    if (key === 'unknown') return CashTrackI18n.t('labels.channel_unknown');
    return key;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}

function renderGroupedTransactionsAsync(categories, channels, from, to) {
    const categoryEl = document.getElementById('categoryGroups');
    const channelEl = document.getElementById('channelGroups');
    if (!categoryEl || !channelEl) return;

    const locale = getLocale();

    function renderGroupShell(container, list, type) {
        if (!list || list.length === 0) {
            container.innerHTML = `<div class="group-empty" data-i18n="dashboard.groups.empty">No transactions</div>`;
            return;
        }
        container.innerHTML = list.map(group => {
            const key = type === 'category' ? group.category : group.channel;
            const title = type === 'category' ? getCategoryLabel(key) : getChannelLabel(key);
            const totalText = (group.amount || 0).toLocaleString(locale, { minimumFractionDigits: 2 });
            return `
                <div class="group-card" data-group-key="${key}" data-group-type="${type}">
                    <button class="group-header" type="button" aria-expanded="false">
                        <div class="group-title">${title}</div>
                        <div class="group-header-meta">
                            <div class="group-total negative">${totalText}</div>
                            <span class="group-toggle-icon"></span>
                        </div>
                    </button>
                    <div class="group-items">
                        <div class="group-loading">
                            <span class="typing-indicator"><span></span><span></span><span></span></span>
                            <span data-i18n="dashboard.groups.loading">Loading...</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    renderGroupShell(categoryEl, categories, 'category');
    renderGroupShell(channelEl, channels, 'channel');

    categories.forEach((group) => {
        const key = group.category;
        fetchTransactions(from, to, { category: key }).then((items) => {
            fillGroupItems(key, 'category', items);
        });
    });

    channels.forEach((group) => {
        const key = group.channel;
        fetchTransactions(from, to, { channel: key }).then((items) => {
            fillGroupItems(key, 'channel', items);
        });
    });

    document.querySelectorAll('.group-card').forEach((card) => {
        card.addEventListener('click', () => {
            const header = card.querySelector('.group-header');
            const isOpen = card.classList.toggle('open');
            if (header) {
                header.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
            }
        });
    });

    function fillGroupItems(key, type, items) {
        const card = document.querySelector(`.group-card[data-group-key="${key}"][data-group-type="${type}"]`);
        if (!card) return;
        const list = card.querySelector('.group-items');
        if (!list) return;
        if (!items || items.length === 0) {
            list.innerHTML = `<div class="group-empty" data-i18n="dashboard.groups.empty">No transactions</div>`;
            return;
        }
        list.innerHTML = items.slice(0, 6).map(tx => {
            const amount = tx.amount || 0;
            const sign = tx.direction === 'income' ? '+' : '-';
            const amountText = `${sign}${amount.toLocaleString(locale, { minimumFractionDigits: 2 })}`;
            const date = tx.txn_date || (tx.created_at ? tx.created_at.split(' ')[0] : '');
            const desc = escapeHtml(tx.description || tx.chat_message || '');
            return `
                <div class="group-item">
                    <div class="group-item-main">
                        <div class="group-item-title">${desc || '-'}</div>
                        <div class="group-item-meta">${date}</div>
                    </div>
                    <div class="group-item-amount ${tx.direction}">${amountText}</div>
                </div>
            `;
        }).join('');
    }
}

async function loadPendingStatus() {
    try {
        const resp = await fetch('/api/transactions/recent');
        if (!resp.ok) return;
        const data = await resp.json();
        const pendingCount = Array.isArray(data) ? data.filter(tx => tx.status === 'pending').length : 0;
        const banner = document.getElementById('pendingBanner');
        if (!banner) return;
        if (pendingCount > 0) {
            banner.classList.remove('hidden');
        } else {
            banner.classList.add('hidden');
        }
    } catch (e) {
        console.error('Failed to load pending status:', e);
    }
}

// Event listeners
document.querySelectorAll('.btn-filter').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const range = getDateRange(btn.dataset.range);
        document.getElementById('fromDate').value = range.from;
        document.getElementById('toDate').value = range.to;
        loadDashboard(range.from, range.to);
    });
});

document.getElementById('applyRange').addEventListener('click', () => {
    const from = document.getElementById('fromDate').value;
    const to = document.getElementById('toDate').value;
    if (from && to) {
        document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
        loadDashboard(from, to);
    }
});

// Initial load
const initialRange = getDateRange('month');
document.getElementById('fromDate').value = initialRange.from;
document.getElementById('toDate').value = initialRange.to;
loadDashboard(initialRange.from, initialRange.to);
loadPendingStatus();
setInterval(loadPendingStatus, 10000);

document.addEventListener('cash-track:lang', () => {
    const from = document.getElementById('fromDate').value;
    const to = document.getElementById('toDate').value;
    if (from && to) {
        loadDashboard(from, to);
    }
    loadPendingStatus();
});
</script>
{{end}}
