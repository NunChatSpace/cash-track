{{define "content"}}
<div class="chat-container">
    <div class="chat-messages" id="chatMessages">
        <div class="message message-bot">
            <div class="message-content" data-i18n="chat.greeting">
                ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ! ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô "‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß 50 ‡∏ö‡∏≤‡∏ó" ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ
            </div>
        </div>
    </div>

    <div class="chat-input-area">
        <div class="image-preview hidden" id="imagePreview">
            <img id="previewImg" src="" alt="Preview">
            <button type="button" class="btn-remove" id="removeImage">&times;</button>
        </div>
        <div class="input-row">
            <label class="btn-upload" for="imageInput">
                <span>üì∑</span>
                <input type="file" id="imageInput" accept="image/*" hidden>
            </label>
            <input type="text" id="messageInput" data-i18n-placeholder="chat.placeholder" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÄ‡∏ä‡πà‡∏ô '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß 50 ‡∏ö‡∏≤‡∏ó'" autocomplete="off">
            <button type="button" class="btn btn-primary" id="sendBtn" data-i18n="chat.send">‡∏™‡πà‡∏á</button>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
const chatMessages = document.getElementById('chatMessages');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const imageInput = document.getElementById('imageInput');
const imagePreview = document.getElementById('imagePreview');
const previewImg = document.getElementById('previewImg');
const removeImage = document.getElementById('removeImage');

let selectedFile = null;
let isSending = false;
let isLoadingHistory = false;
let historyOffset = 0;
const historyLimit = 20;

function createMessageElement(text, isUser = false, txId = null, isLoading = false) {
    const div = document.createElement('div');
    div.className = `message ${isUser ? 'message-user' : 'message-bot'}`;
    if (isLoading) {
        div.classList.add('message-loading');
    }
    if (txId) {
        div.dataset.txId = txId;
    }

    let content = `<div class="message-content">${escapeHtml(text)}</div>`;
    if (txId) {
        content += `<a href="/transactions/${txId}/confirm" class="btn btn-small">${CashTrackI18n.t('chat.edit')}</a>`;
    }
    if (!isUser) {
        const locale = CashTrackI18n.getLocale();
        const assistantLabel = CashTrackI18n.t('chat.assistant');
        content += `<div class="message-meta">${isLoading ? '<span class="typing-indicator"><span></span><span></span><span></span></span>' : assistantLabel} ‚Ä¢ ${new Date().toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit' })}</div>`;
    }

    div.innerHTML = content;
    return div;
}

function addMessage(text, isUser = false, txId = null, isLoading = false) {
    const el = createMessageElement(text, isUser, txId, isLoading);
    chatMessages.appendChild(el);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    return el;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function createImageMessageElement(src, filename) {
    const div = document.createElement('div');
    div.className = 'message message-user';
    const safeName = escapeHtml(filename || '');
    div.innerHTML = `
        <div class="message-content message-image-content">
            <div class="message-image">
                <img src="${src}" alt="${safeName}">
            </div>
            ${safeName ? `<div class="message-caption">${safeName}</div>` : ''}
        </div>
    `;
    return div;
}

function addImageMessage(src, filename) {
    const el = createImageMessageElement(src, filename);
    chatMessages.appendChild(el);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    return el;
}

function formatTxMessage(tx) {
    const direction = tx.direction === 'income' ? '+' : '-';
    const category = tx.category ? ` [${tx.category}]` : '';
    const desc = tx.description || '';
    const date = tx.txn_date || (tx.created_at ? tx.created_at.split(' ')[0] : '');
    if (tx.amount && tx.amount > 0) {
        return `${date}: ${direction}${tx.amount.toFixed(2)} ${tx.currency}${category} ${desc}`.trim();
    }
    return CashTrackI18n.t('history.processing');
}

const pendingPollers = new Map();

function startPendingPoll(txId) {
    if (pendingPollers.has(txId)) return;
    const interval = setInterval(async () => {
        try {
            const resp = await fetch(`/api/transactions/${txId}`);
            if (!resp.ok) return;
            const tx = await resp.json();
            const messageEl = document.querySelector(`.message[data-tx-id="${txId}"]`);
            if (!messageEl) {
                clearInterval(interval);
                pendingPollers.delete(txId);
                return;
            }
            if (tx.amount && tx.amount > 0) {
                const content = messageEl.querySelector('.message-content');
                if (content) content.textContent = formatTxMessage(tx);
                messageEl.classList.remove('message-loading');
                const meta = messageEl.querySelector('.message-meta');
                if (meta) {
                    const locale = CashTrackI18n.getLocale();
                    meta.innerHTML = `${CashTrackI18n.t('chat.assistant')} ‚Ä¢ ${new Date().toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit' })}`;
                }
                clearInterval(interval);
                pendingPollers.delete(txId);
            }
        } catch (e) {
            console.error('Pending poll failed:', e);
        }
    }, 3000);
    pendingPollers.set(txId, interval);
}

async function sendMessage() {
    const message = messageInput.value.trim();
    if (!message && !selectedFile) return;
    if (isSending) return;
    isSending = true;
    sendBtn.disabled = true;

    // Show user message
    if (message) {
        addMessage(message, true);
    }
    let pendingImage = null;
    let objectUrl = null;
    if (selectedFile) {
        objectUrl = URL.createObjectURL(selectedFile);
        pendingImage = addImageMessage(objectUrl, selectedFile.name);
    }

    messageInput.value = '';
    const loadingMessage = addMessage(CashTrackI18n.t('chat.thinking'), false, null, true);

    // Prepare request
    const body = {
        message: message,
        image_path: null,
        lang: CashTrackI18n.getLang()
    };

    // If there's an image, upload it first
    if (selectedFile) {
        const formData = new FormData();
        formData.append('slip', selectedFile);

        try {
            const uploadResp = await fetch('/api/transactions/slip', {
                method: 'POST',
                body: formData
            });
            if (uploadResp.ok) {
                const data = await uploadResp.json();
                body.image_path = data.image_path;
                body.transaction_id = data.id;
                if (pendingImage) {
                    const img = pendingImage.querySelector('img');
                    if (img) img.src = `/uploads/${data.image_path}`;
                    if (objectUrl) URL.revokeObjectURL(objectUrl);
                }
            }
        } catch (e) {
            console.error('Upload failed:', e);
        }

        clearImage();
    }

    // Send chat request
    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        if (response.ok) {
            const data = await response.json();
            loadingMessage.querySelector('.message-content').textContent = data.reply_text;
            loadingMessage.classList.remove('message-loading');
            const meta = loadingMessage.querySelector('.message-meta');
            if (meta) {
                const locale = CashTrackI18n.getLocale();
                meta.innerHTML = `${CashTrackI18n.t('chat.assistant')} ‚Ä¢ ${new Date().toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit' })}`;
            }
            if (data.transaction_id) {
                const link = document.createElement('a');
                link.href = `/transactions/${data.transaction_id}/confirm`;
                link.className = 'btn btn-small';
                link.textContent = CashTrackI18n.t('chat.edit');
                loadingMessage.appendChild(link);
            }
        } else {
            loadingMessage.querySelector('.message-content').textContent = CashTrackI18n.t('chat.error_failed');
            loadingMessage.classList.remove('message-loading');
            const meta = loadingMessage.querySelector('.message-meta');
            if (meta) meta.textContent = CashTrackI18n.t('chat.assistant');
        }
    } catch (e) {
        console.error('Chat error:', e);
        loadingMessage.querySelector('.message-content').textContent = CashTrackI18n.t('chat.error_connect');
        loadingMessage.classList.remove('message-loading');
        const meta = loadingMessage.querySelector('.message-meta');
        if (meta) meta.textContent = CashTrackI18n.t('chat.assistant');
    }
    isSending = false;
    sendBtn.disabled = false;
}

function clearImage() {
    selectedFile = null;
    imagePreview.classList.add('hidden');
    previewImg.src = '';
    imageInput.value = '';
}

// Event listeners
sendBtn.addEventListener('click', sendMessage);

messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

imageInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        selectedFile = e.target.files[0];
        previewImg.src = URL.createObjectURL(selectedFile);
        imagePreview.classList.remove('hidden');
    }
});

removeImage.addEventListener('click', clearImage);

// Load recent transactions on page load
async function loadHistory() {
    if (isLoadingHistory) return;
    isLoadingHistory = true;
    try {
        const response = await fetch(`/api/transactions/recent?limit=${historyLimit}&offset=${historyOffset}`);
        if (response.ok) {
            const transactions = await response.json();
            if (transactions && transactions.length > 0) {
                const isInitial = historyOffset === 0;
                // Show in chronological order (oldest first)
                const pendingIds = [];
                const nodes = [];
                transactions.reverse().forEach(tx => {
                    if (tx.chat_message) {
                        nodes.push(createMessageElement(tx.chat_message, true));
                    }
                    if (tx.slip_image_path) {
                        nodes.push(createImageMessageElement(`/uploads/${tx.slip_image_path}`, tx.slip_image_path));
                    }
                    const msg = formatTxMessage(tx);
                    const isPending = tx.status === 'pending' && (!tx.amount || tx.amount === 0);
                    nodes.push(createMessageElement(msg, false, tx.status === 'pending' ? tx.id : null, isPending));
                    if (isPending) pendingIds.push(tx.id);
                });
                if (isInitial) {
                    nodes.forEach((node) => chatMessages.appendChild(node));
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } else {
                    const previousScrollHeight = chatMessages.scrollHeight;
                    const firstChild = chatMessages.firstChild;
                    nodes.forEach((node) => chatMessages.insertBefore(node, firstChild));
                    const newScrollHeight = chatMessages.scrollHeight;
                    chatMessages.scrollTop = newScrollHeight - previousScrollHeight;
                }
                historyOffset += transactions.length;
                pendingIds.forEach(startPendingPoll);
            }
        }
    } catch (e) {
        console.error('Failed to load history:', e);
    } finally {
        isLoadingHistory = false;
    }
}

loadHistory();

chatMessages.addEventListener('scroll', () => {
    if (chatMessages.scrollTop <= 10) {
        loadHistory();
    }
});
</script>
{{end}}
