{{define "layout"}}
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cash Track - {{.Title}}</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <nav class="navbar">
        <a href="/" class="logo">Cash Track</a>
        <div class="nav-actions">
            <div class="user-badge nav-user-badge" id="userBadge">U</div>
            <button class="nav-toggle" id="navToggle" type="button" aria-label="Toggle menu" aria-expanded="false">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
        <div class="nav-links" id="navLinks">
            <a href="/dashboard" data-i18n="nav.dashboard">Dashboard</a>
            <a href="/history" data-i18n="nav.history">History</a>
            <a href="/users" data-i18n="nav.users">Users</a>
        </div>
        <div class="nav-tools">
            <div class="lang-switch">
                <select id="langSelect" aria-label="Language">
                    <option value="th" data-flag="/static/icons/th.png">Thai</option>
                    <option value="en" data-flag="/static/icons/us.png">English</option>
                </select>
            </div>
        </div>
        <div class="user-switch">
            <div class="user-badge">U</div>
            <div class="user-controls">
                <select id="userSelect"></select>
                <div class="user-meta"></div>
            </div>
        </div>
    </nav>
    <main class="container">
        {{template "content" .}}
    </main>
    {{template "scripts" .}}
    <script>
    (function initI18n() {
        const I18N = {
            th: {
                nav: { dashboard: 'Dashboard', history: 'History', users: 'Users', toggle: 'เปิด/ปิดเมนู' },
                user: {
                    add_option: '+ เพิ่มผู้ใช้',
                    add_prompt: 'ชื่อผู้ใช้ใหม่',
                    add_failed: 'เพิ่มผู้ใช้ไม่สำเร็จ',
                    cutoff_prompt: 'ตัดรอบทุกๆวันที่ (1-30)',
                    cutoff_error: 'ตัดรอบต้องอยู่ระหว่าง 1 ถึง 30',
                    cutoff_failed: 'อัปเดตตัดรอบไม่สำเร็จ',
                    cutoff_label: 'ตัดรอบทุกๆวันที่ {day}'
                },
                dashboard: {
                    title: 'Dashboard',
                    range: { month: 'เดือนนี้', last_month: 'เดือนที่แล้ว', year: 'ปีนี้', to: 'ถึง', apply: 'ใช้' },
                    summary: { expense: 'รายจ่าย', income: 'รายรับ', net: 'คงเหลือ' },
                    charts: { by_category: 'รายจ่ายตามหมวด', by_channel: 'รายจ่ายตามช่องทาง' },
                    amount_thb: 'จำนวนเงิน (บาท)'
                },
                chat: {
                    greeting: 'สวัสดี! พิมพ์รายจ่ายได้เลย เช่น "กินข้าว 50 บาท" หรืออัปโหลดรูปสลิป',
                    placeholder: "พิมพ์ข้อความ เช่น 'วันนี้กินข้าว 50 บาท'",
                    send: 'ส่ง',
                    thinking: 'กำลังคิด...',
                    assistant: 'ผู้ช่วย',
                    edit: 'ดู/แก้ไข',
                    error_failed: 'เกิดข้อผิดพลาด กรุณาลองใหม่',
                    error_connect: 'ไม่สามารถเชื่อมต่อได้',
                    image_prefix: 'รูปภาพ'
                },
                history: {
                    title: 'ประวัติรายการ',
                    empty: 'ยังไม่มีรายการ',
                    empty_cta: 'เริ่มแชต',
                    confirm: 'ยืนยัน',
                    edit: 'แก้ไข',
                    delete: 'ลบ',
                    delete_confirm: 'ลบรายการนี้หรือไม่?',
                    delete_failed: 'ลบรายการไม่สำเร็จ',
                    confirm_failed: 'ยืนยันรายการไม่สำเร็จ'
                },
                users: {
                    title: 'ผู้ใช้',
                    new_placeholder: 'ชื่อผู้ใช้ใหม่',
                    add: 'เพิ่มผู้ใช้',
                    remove: 'ลบ',
                    remove_confirm: 'ลบผู้ใช้และรายการทั้งหมดหรือไม่?',
                    remove_failed: 'ลบผู้ใช้ไม่สำเร็จ',
                    cutoff_label: 'ตัดรอบ {day}'
                },
                confirm: {
                    title: 'ยืนยันรายการ',
                    no_image: 'ไม่มีรูป',
                    amount: 'จำนวนเงิน (บาท)',
                    date: 'วันที่',
                    type: 'ประเภท',
                    type_expense: 'รายจ่าย',
                    type_income: 'รายรับ',
                    type_transfer: 'โอน',
                    category: 'หมวดหมู่',
                    category_select: 'เลือกหมวดหมู่',
                    channel: 'ช่องทาง',
                    channel_select: 'เลือกช่องทาง',
                    description: 'รายละเอียด',
                    description_placeholder: 'คำอธิบายสั้นๆ',
                    cancel: 'ยกเลิก',
                    delete: 'ลบ',
                    confirm: 'ยืนยัน',
                    ocr_view: 'ดูข้อความ OCR ดิบ',
                    delete_confirm: 'ลบรายการนี้หรือไม่?',
                    confirm_failed: 'ยืนยันรายการไม่สำเร็จ',
                    delete_failed: 'ลบรายการไม่สำเร็จ'
                },
                upload: {
                    title: 'อัปโหลดสลิปธนาคาร',
                    drag: 'ลากและวางรูปสลิปของคุณที่นี่',
                    hint: 'หรือคลิกเพื่อเลือกไฟล์',
                    process: 'ประมวลผลสลิป',
                    processing: 'กำลังประมวลผลสลิป...',
                    select_image_error: 'กรุณาเลือกไฟล์รูปภาพ',
                    upload_failed: 'อัปโหลดไม่สำเร็จ: '
                },
                labels: {
                    status_pending: 'รอยืนยัน',
                    status_confirmed: 'ยืนยันแล้ว',
                    channel_cash: 'เงินสด',
                    channel_scb: 'SCB',
                    channel_kbank: 'KBank',
                    channel_tmw: 'TrueMoney',
                    channel_bbl: 'Bangkok Bank',
                    channel_ktb: 'Krungthai',
                    channel_other: 'อื่นๆ',
                    channel_unknown: 'ไม่ทราบ',
                    thb: 'บาท'
                },
                categories: {
                    food: 'อาหาร',
                    shopping: 'ช้อปปิ้ง',
                    transport: 'เดินทาง',
                    bill: 'ค่าบริการ',
                    rent: 'ค่าเช่า',
                    debt: 'หนี้สิน',
                    other: 'อื่นๆ',
                    uncategorized: 'ไม่ระบุ'
                }
            },
            en: {
                nav: { dashboard: 'Dashboard', history: 'History', users: 'Users', toggle: 'Toggle menu' },
                user: {
                    add_option: '+ Add user',
                    add_prompt: 'New user name',
                    add_failed: 'Failed to create user',
                    cutoff_prompt: 'Cutoff day (1-30)',
                    cutoff_error: 'Cutoff day must be between 1 and 30',
                    cutoff_failed: 'Failed to update cutoff',
                    cutoff_label: 'Cutoff day {day}'
                },
                dashboard: {
                    title: 'Dashboard',
                    range: { month: 'This month', last_month: 'Last month', year: 'This year', to: 'to', apply: 'Apply' },
                    summary: { expense: 'Expense', income: 'Income', net: 'Net' },
                    charts: { by_category: 'Expense by category', by_channel: 'Expense by channel' },
                    amount_thb: 'Amount (THB)'
                },
                chat: {
                    greeting: 'Hi! Type an expense like "lunch 50" or upload a slip image.',
                    placeholder: "Type a message like 'lunch 50'",
                    send: 'Send',
                    thinking: 'Thinking...',
                    assistant: 'Assistant',
                    edit: 'View/Edit',
                    error_failed: 'Something went wrong. Please try again.',
                    error_connect: 'Unable to connect.',
                    image_prefix: 'Image'
                },
                history: {
                    title: 'Transaction History',
                    empty: 'No transactions yet',
                    empty_cta: 'Start chatting',
                    confirm: 'Confirm',
                    edit: 'Edit',
                    delete: 'Delete',
                    delete_confirm: 'Delete this transaction?',
                    delete_failed: 'Failed to delete transaction',
                    confirm_failed: 'Failed to confirm transaction'
                },
                users: {
                    title: 'Users',
                    new_placeholder: 'New user name',
                    add: 'Add user',
                    remove: 'Remove',
                    remove_confirm: 'Remove this user and all their transactions?',
                    remove_failed: 'Failed to remove user',
                    cutoff_label: 'Cutoff {day}'
                },
                confirm: {
                    title: 'Confirm Transaction',
                    no_image: 'No image',
                    amount: 'Amount (THB)',
                    date: 'Date',
                    type: 'Type',
                    type_expense: 'Expense',
                    type_income: 'Income',
                    type_transfer: 'Transfer',
                    category: 'Category',
                    category_select: 'Select category',
                    channel: 'Channel',
                    channel_select: 'Select channel',
                    description: 'Description',
                    description_placeholder: 'Short description',
                    cancel: 'Cancel',
                    delete: 'Delete',
                    confirm: 'Confirm',
                    ocr_view: 'View Raw OCR Text',
                    delete_confirm: 'Delete this transaction?',
                    confirm_failed: 'Failed to confirm transaction',
                    delete_failed: 'Failed to delete transaction'
                },
                upload: {
                    title: 'Upload Bank Slip',
                    drag: 'Drag and drop your slip image here',
                    hint: 'or click to select a file',
                    process: 'Process Slip',
                    processing: 'Processing your slip...',
                    select_image_error: 'Please select an image file',
                    upload_failed: 'Failed to upload: '
                },
                labels: {
                    status_pending: 'Pending',
                    status_confirmed: 'Confirmed',
                    channel_cash: 'Cash',
                    channel_scb: 'SCB',
                    channel_kbank: 'KBank',
                    channel_tmw: 'TrueMoney',
                    channel_bbl: 'Bangkok Bank',
                    channel_ktb: 'Krungthai',
                    channel_other: 'Other',
                    channel_unknown: 'Unknown',
                    thb: 'THB'
                },
                categories: {
                    food: 'Food',
                    shopping: 'Shopping',
                    transport: 'Transport',
                    bill: 'Bills',
                    rent: 'Rent',
                    debt: 'Debt',
                    other: 'Other',
                    uncategorized: 'Uncategorized'
                }
            }
        };

        const LOCALES = { th: 'th-TH', en: 'en-US' };
        const FALLBACK_LANG = 'th';

        function normalizeLang(lang) {
            return lang === 'en' ? 'en' : 'th';
        }

        function getLang() {
            const stored = localStorage.getItem('cash-track-lang');
            return normalizeLang(stored || FALLBACK_LANG);
        }

        function setLang(lang) {
            const safe = normalizeLang(lang);
            localStorage.setItem('cash-track-lang', safe);
            document.documentElement.lang = safe;
            const select = document.getElementById('langSelect');
            if (select) select.value = safe;
            applyTranslations();
            document.dispatchEvent(new CustomEvent('cash-track:lang', { detail: { lang: safe } }));
        }

        function t(key, vars) {
            const lang = getLang();
            const dict = I18N[lang] || I18N[FALLBACK_LANG];
            const parts = key.split('.');
            let cur = dict;
            for (const part of parts) {
                if (!cur || typeof cur !== 'object') return key;
                cur = cur[part];
            }
            if (typeof cur !== 'string') return key;
            if (!vars) return cur;
            return cur.replace(/\{(\w+)\}/g, (_, name) => (vars[name] !== undefined ? vars[name] : `{${name}}`));
        }

        function applyTranslations() {
            const lang = getLang();
            const root = document;
            root.querySelectorAll('[data-i18n]').forEach((el) => {
                const key = el.getAttribute('data-i18n');
                el.textContent = t(key);
            });
            root.querySelectorAll('[data-i18n-placeholder]').forEach((el) => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.setAttribute('placeholder', t(key));
            });
            root.querySelectorAll('[data-i18n-aria]').forEach((el) => {
                const key = el.getAttribute('data-i18n-aria');
                el.setAttribute('aria-label', t(key));
            });

            const toggle = document.getElementById('navToggle');
            if (toggle) toggle.setAttribute('aria-label', t('nav.toggle'));

            root.querySelectorAll('.status-badge[data-status]').forEach((el) => {
                const status = el.dataset.status;
                if (status === 'pending') el.textContent = t('labels.status_pending');
                if (status === 'confirmed') el.textContent = t('labels.status_confirmed');
            });

            root.querySelectorAll('.category-badge[data-category]').forEach((el) => {
                const key = el.dataset.category;
                if (key) el.textContent = t(`categories.${key}`);
            });

            root.querySelectorAll('.channel-badge[data-channel]').forEach((el) => {
                const key = el.dataset.channel;
                if (key === 'cash') el.textContent = t('labels.channel_cash');
                if (key === 'scb') el.textContent = t('labels.channel_scb');
                if (key === 'kbank') el.textContent = t('labels.channel_kbank');
                if (key === 'tmw') el.textContent = t('labels.channel_tmw');
                if (key === 'bbl') el.textContent = t('labels.channel_bbl');
                if (key === 'ktb') el.textContent = t('labels.channel_ktb');
                if (key === 'other') el.textContent = t('labels.channel_other');
                if (key === 'unknown') el.textContent = t('labels.channel_unknown');
            });

            if (lang === 'en') {
                document.querySelectorAll('.btn-filter').forEach((btn) => {
                    if (btn.dataset.range === 'month') btn.textContent = t('dashboard.range.month');
                    if (btn.dataset.range === 'last-month') btn.textContent = t('dashboard.range.last_month');
                    if (btn.dataset.range === 'year') btn.textContent = t('dashboard.range.year');
                });
            }

            if (window.CashTrackSelect && window.CashTrackSelect.refreshAll) {
                window.CashTrackSelect.refreshAll();
            }
        }

        const langSelect = document.getElementById('langSelect');
        if (langSelect) {
            langSelect.addEventListener('change', () => setLang(langSelect.value));
            langSelect.value = getLang();
        }

        window.CashTrackI18n = {
            t,
            getLang,
            getLocale: () => LOCALES[getLang()] || LOCALES[FALLBACK_LANG],
            categories: () => (I18N[getLang()] || I18N[FALLBACK_LANG]).categories,
        };

        applyTranslations();
    })();

    (function initCustomSelects() {
        function createOptionLabel(opt) {
            const label = document.createElement('span');
            label.className = 'custom-select-label';
            if (opt.dataset && opt.dataset.flag) {
                const flag = document.createElement('img');
                flag.className = 'custom-select-flag';
                flag.src = opt.dataset.flag;
                flag.alt = '';
                flag.loading = 'lazy';
                label.appendChild(flag);
            }
            const text = document.createElement('span');
            text.className = 'custom-select-text';
            text.textContent = opt.textContent;
            label.appendChild(text);
            return label;
        }

        function enhanceSelect(select) {
            if (!select || select.dataset.enhanced === 'true') return;
            const wrapper = document.createElement('div');
            wrapper.className = 'custom-select';
            const trigger = document.createElement('button');
            trigger.type = 'button';
            trigger.className = 'custom-select-trigger';
            trigger.setAttribute('aria-haspopup', 'listbox');
            trigger.setAttribute('aria-expanded', 'false');
            const list = document.createElement('ul');
            list.className = 'custom-select-options';
            list.setAttribute('role', 'listbox');

            select.parentNode.insertBefore(wrapper, select);
            wrapper.appendChild(select);
            wrapper.appendChild(trigger);
            wrapper.appendChild(list);
            select.dataset.enhanced = 'true';
            select.classList.add('select-native');

            function buildOptions() {
                list.innerHTML = '';
                Array.from(select.options).forEach((opt) => {
                    const item = document.createElement('li');
                    item.className = 'custom-select-option';
                    item.appendChild(createOptionLabel(opt));
                    item.dataset.value = opt.value;
                    item.setAttribute('role', 'option');
                    if (opt.disabled) {
                        item.classList.add('disabled');
                        item.setAttribute('aria-disabled', 'true');
                    }
                    if (opt.selected) {
                        item.classList.add('selected');
                        item.setAttribute('aria-selected', 'true');
                    }
                    item.addEventListener('click', () => {
                        if (opt.disabled) return;
                        select.value = opt.value;
                        select.dispatchEvent(new Event('change', { bubbles: true }));
                        closeSelect(wrapper, trigger);
                        updateTrigger();
                        syncSelected();
                    });
                    list.appendChild(item);
                });
            }

            function updateTrigger() {
                const selected = select.options[select.selectedIndex];
                trigger.innerHTML = '';
                if (selected) {
                    trigger.appendChild(createOptionLabel(selected));
                }
            }

            function syncSelected() {
                Array.from(list.children).forEach((item) => {
                    item.classList.remove('selected');
                    item.removeAttribute('aria-selected');
                    if (item.dataset.value === select.value) {
                        item.classList.add('selected');
                        item.setAttribute('aria-selected', 'true');
                    }
                });
            }

            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = wrapper.classList.contains('open');
                closeAllSelects();
                if (!isOpen) {
                    wrapper.classList.add('open');
                    trigger.setAttribute('aria-expanded', 'true');
                }
            });

            select.addEventListener('change', () => {
                updateTrigger();
                syncSelected();
            });

            buildOptions();
            updateTrigger();
        }

        function closeSelect(wrapper, trigger) {
            if (!wrapper) return;
            wrapper.classList.remove('open');
            if (trigger) trigger.setAttribute('aria-expanded', 'false');
        }

        function closeAllSelects() {
            document.querySelectorAll('.custom-select.open').forEach((el) => {
                const trigger = el.querySelector('.custom-select-trigger');
                closeSelect(el, trigger);
            });
        }

        document.addEventListener('click', () => closeAllSelects());

        function refresh(select) {
            if (!select) return;
            if (select.dataset.enhanced !== 'true') {
                enhanceSelect(select);
                return;
            }
            const wrapper = select.closest('.custom-select');
            if (!wrapper) return;
            const list = wrapper.querySelector('.custom-select-options');
            const trigger = wrapper.querySelector('.custom-select-trigger');
            if (!list || !trigger) return;
            list.innerHTML = '';
            Array.from(select.options).forEach((opt) => {
                const item = document.createElement('li');
                item.className = 'custom-select-option';
                item.appendChild(createOptionLabel(opt));
                item.dataset.value = opt.value;
                item.setAttribute('role', 'option');
                if (opt.disabled) {
                    item.classList.add('disabled');
                    item.setAttribute('aria-disabled', 'true');
                }
                if (opt.selected) {
                    item.classList.add('selected');
                    item.setAttribute('aria-selected', 'true');
                }
                item.addEventListener('click', () => {
                    if (opt.disabled) return;
                    select.value = opt.value;
                    select.dispatchEvent(new Event('change', { bubbles: true }));
                    closeSelect(wrapper, trigger);
                    trigger.innerHTML = '';
                    trigger.appendChild(createOptionLabel(opt));
                    list.querySelectorAll('.custom-select-option').forEach((li) => li.classList.remove('selected'));
                    item.classList.add('selected');
                });
                list.appendChild(item);
            });
            const selected = select.options[select.selectedIndex];
            trigger.innerHTML = '';
            if (selected) {
                trigger.appendChild(createOptionLabel(selected));
            }
        }

        function refreshAll() {
            document.querySelectorAll('select').forEach((select) => refresh(select));
        }

        window.CashTrackSelect = { enhance: enhanceSelect, refresh, refreshAll };
        refreshAll();
    })();

    (async function initUserSwitch() {
        const select = document.getElementById('userSelect');
        const badge = document.getElementById('userBadge');
        const cutoffBtn = document.getElementById('cutoffBtn');
        if (!select || !badge) return;

        async function loadUsers() {
            const resp = await fetch('/api/users');
            if (!resp.ok) return;
            const data = await resp.json();
            select.innerHTML = '';
            data.users.forEach((user) => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                if (user.id === data.current_user_id) {
                    option.selected = true;
                    updateBadge(user.name);
                    if (cutoffBtn) {
                        cutoffBtn.textContent = CashTrackI18n.t('user.cutoff_label', { day: user.cutoff_day });
                        cutoffBtn.dataset.cutoff = user.cutoff_day;
                        cutoffBtn.dataset.userId = user.id;
                    }
                }
                select.appendChild(option);
            });

            const addOption = document.createElement('option');
            addOption.value = 'add';
            addOption.textContent = CashTrackI18n.t('user.add_option');
            select.appendChild(addOption);
            if (window.CashTrackSelect) {
                CashTrackSelect.refresh(select);
            }
        }

        select.addEventListener('change', async () => {
            if (select.value === 'add') {
                const name = prompt(CashTrackI18n.t('user.add_prompt'));
                if (!name) {
                    await loadUsers();
                    return;
                }
                const resp = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                if (resp.ok) {
                    await loadUsers();
                    window.location.reload();
                } else {
                    alert(CashTrackI18n.t('user.add_failed'));
                    await loadUsers();
                }
                return;
            }

            const userId = parseInt(select.value, 10);
            if (!userId) return;
            updateBadge(select.options[select.selectedIndex]?.textContent || 'U');
            await fetch('/api/users/select', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId })
            });
            window.location.reload();
        });

        function updateBadge(name) {
            const letter = name ? name.trim().charAt(0).toUpperCase() : 'U';
            document.querySelectorAll('#userBadge, .user-switch .user-badge').forEach((el) => {
                if (el) el.textContent = letter;
            });
        }

        if (cutoffBtn) {
            cutoffBtn.addEventListener('click', async () => {
                const userId = parseInt(cutoffBtn.dataset.userId, 10);
                if (!userId) return;
                const current = cutoffBtn.dataset.cutoff || '1';
                const input = prompt(CashTrackI18n.t('user.cutoff_prompt'), current);
                if (!input) return;
                const day = parseInt(input, 10);
                if (!day || day < 1 || day > 30) {
                    alert(CashTrackI18n.t('user.cutoff_error'));
                    return;
                }
                const resp = await fetch(`/api/users/${userId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cutoff_day: day })
                });
                if (resp.ok) {
                    await loadUsers();
                    window.location.reload();
                } else {
                    alert(CashTrackI18n.t('user.cutoff_failed'));
                }
            });
        }


        await loadUsers();
        if (window.CashTrackSelect) {
            CashTrackSelect.refresh(select);
        }
        document.addEventListener('cash-track:lang', () => {
            loadUsers();
        });
    })();

    (function initNavToggle() {
        const toggle = document.getElementById('navToggle');
        const links = document.getElementById('navLinks');
        if (!toggle || !links) return;
        toggle.addEventListener('click', () => {
            const isOpen = links.classList.toggle('open');
            toggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        });
    })();
    </script>
</body>
</html>
{{end}}

{{define "scripts"}}{{end}}
