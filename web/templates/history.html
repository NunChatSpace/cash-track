{{define "content"}}
<div class="history-section">
    <h1>Transaction History</h1>
    {{if .Transactions}}
    <div class="transactions-list">
        {{range .Transactions}}
        <div class="transaction-card status-{{.Status}}" data-transaction-id="{{.ID}}" data-amount="{{.Amount}}" data-txn-date="{{.TxnDate}}" data-direction="{{.Direction}}" data-channel="{{.Channel}}" data-category="{{.Category}}" data-description="{{.Description}}" data-account-label="{{.AccountLabel}}">
            {{if or .SlipImagePath .ImagePath}}
            <div class="transaction-thumb">
                <img src="/uploads/{{if .SlipImagePath}}{{.SlipImagePath}}{{else}}{{.ImagePath}}{{end}}" alt="Slip">
            </div>
            {{end}}
            <div class="transaction-info">
                <div class="transaction-amount {{.Direction}}">
                    {{if eq .Direction "income"}}+{{else}}-{{end}}{{printf "%.2f" .Amount}} {{.Currency}}
                </div>
                <div class="transaction-details">
                    {{if .Description}}<span>{{.Description}}</span>{{end}}
                </div>
                <div class="transaction-meta">
                    <span class="channel-badge">{{if .Channel}}{{.Channel}}{{else}}unknown{{end}}</span>
                    <span class="category-badge">{{if .Category}}{{.Category}}{{else}}uncategorized{{end}}</span>
                    <span class="status-badge status-{{.Status}}">{{.Status}}</span>
                    {{if .TxnDate}}<span class="date">{{.TxnDate}}</span>{{else}}<span class="date">{{.CreatedAt}}</span>{{end}}
                </div>
            </div>
            <div class="transaction-actions">
                {{if eq .Status "pending"}}
                <button type="button" class="btn btn-small btn-primary confirm-transaction" data-id="{{.ID}}">Confirm</button>
                {{end}}
                <a href="/transactions/{{.ID}}/confirm" class="btn btn-small">Edit</a>
                <button type="button" class="btn btn-small btn-danger delete-transaction" data-id="{{.ID}}">Delete</button>
            </div>
        </div>
        {{end}}
    </div>
    {{else}}
    <div class="empty-state">
        <p>No transactions yet</p>
        <a href="/chat" class="btn btn-primary">Start chatting</a>
    </div>
    {{end}}
</div>
{{end}}

{{define "scripts"}}
<script>
document.querySelectorAll('.delete-transaction').forEach((btn) => {
    btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        if (!id) return;
        if (!confirm('Delete this transaction?')) return;

        try {
            const resp = await fetch(`/api/transactions/${id}`, { method: 'DELETE' });
            if (!resp.ok) {
                throw new Error('Delete failed');
            }
            const card = btn.closest('.transaction-card');
            if (card) card.remove();
        } catch (err) {
            alert('Failed to delete transaction');
        }
    });
});

document.querySelectorAll('.confirm-transaction').forEach((btn) => {
    btn.addEventListener('click', async () => {
        const card = btn.closest('.transaction-card');
        if (!card) return;
        const id = btn.dataset.id;
        const payload = {
            amount: parseFloat(card.dataset.amount) || 0,
            txn_date: card.dataset.txnDate || '',
            direction: card.dataset.direction || 'expense',
            channel: card.dataset.channel || '',
            account_label: card.dataset.accountLabel || '',
            category: card.dataset.category || '',
            description: card.dataset.description || ''
        };
        try {
            const resp = await fetch(`/api/transactions/${id}/confirm`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!resp.ok) throw new Error('Confirm failed');
            card.classList.remove('status-pending');
            card.classList.add('status-confirmed');
            const status = card.querySelector('.status-badge');
            if (status) {
                status.textContent = 'confirmed';
                status.classList.remove('status-pending');
                status.classList.add('status-confirmed');
            }
            btn.remove();
        } catch (err) {
            alert('Failed to confirm transaction');
        }
    });
});
</script>
{{end}}
